<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>Pol Angles — J. Cornelison</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <!-- Load up MathJax for math notation -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
              tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
    </script>
    <script type="text/javascript"
            src="../mathjax/MathJax.js?config=TeX-AMS-MML_SVG">
            // src="../mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

</head>

<body>
<!-- Add my custom pager script -->
<script type="text/javascript" src="scripts/pager.js"></script>
<link rel="stylesheet" type="text/css" href="scripts/pager.css">

<header>
    <h1>RPS Analysis: Polarization Angles and Cross-polar responses</h1>

    <time datetime="2020-xx-xx" class="published updated">
        yyyy Mmm dd
    </time> —
    J. Cornelison
</header>

<hr>

<p>
    Outline:
</p>
<ol>
    <li>Intro</li>
    <ol type="A">
        <li>Recap of definitions and parameter estimation</li>
        <li>Schedule types</li>
    </ol>
    <li>Results</li>
    <ol type="A">
        <li>phi/eps vs. channel</li>
        <li>Focal plane averages</li>
    </ol>
    <li>Uncertainties & Systematics</li>
    <ol type="A">
        <li>Consistency checks</li>
        <ul>
            <li>2018 Vs. 2022</li>
            <li>2022 self-consistency</li>
        </ul>
        <li>Cross-checks with Type-9's</li>
        <ul>
            <li>Type-9 phi/eps vs. time, DK, N-Rotations, etc</li>
        </ul>
    </ol>
</ol>



<hr>
<!--
- This is a presentation of the RPS-derived angles
- These are the schedules we used during the measurement
- This is how we fit angles
- These are the angles
-- phi-pair, phia, phib
-- compared fiducial
- This section attempts to understand the uncertainties
-->
<section><h2>Introduction</h2>

<h3>RPS Analysis in a nutshell</h3>

    <p>
        The general approach to converting the RPS data to estimations on the polarization angles and cross-polar response of a given detector is to done in two parts: fit 2D Gaussians to a rasterstet to derive the amplitudes of a modulation curve and then fit a sinusoidal function to the modulation curve to derive the polarization angle and cross-polar response (see Figure 1.1 below).
    </p>

    <figure>
        <img src="figs\spie_mod_curve.png"/>
        <figcaption>

        </figcaption>
    </figure>


    <p>The Gaussian we fit is done at the timestream level in raw mount coordinates <a href="KWY2007"></a> and is of the form:</p>

    \begin{equation}
    B(\mathbf{x}) = A e^{(\mathbf{x}-\mathbf{\mu})^T\Sigma^{-1}(\mathbf{x}-\mathbf{\mu})}
    \end{equation}
    Where $A$ is the amplitude, $\mathbf{\mu} = (Az_0\,\,El_0)$ is the beam centroid, and

    \begin{equation}
    \Sigma =
    \begin{bmatrix} \sigma_{Az}^2& \rho \sigma_{Az} \sigma_{El} \\ \rho \sigma_{Az} \sigma_{El} & \sigma_{El}^2 \end{bmatrix}
    \end{equation}

    <p>
        where $(\sigma_{Az},\,\sigma_{El})$ is the beam width, and $\rho$ is the beam ellipticity. The significant difference between this analysis and other analyses involving beams is that we include 13 amplitude parameters to account for each beam in the modulation curve while fitting only a single $Az_0$, $El_0$, $\sigma_{Az}$, $\sigma_{El}$, and $\rho$ parameter across all the beams in a rasterset. This is to mitigate pointing effects from the Roger Effect <a href="RWO2013"></a> and to allow good beam centroid fits for rasters during which the RPS angle is orthogonal to a given detector and the SNR on the beam amplitude is low.
    </p>

    <p>Once we have our modulation curve, we could fit a sinusoidal function of the form:</p>

    \begin{equation}\label{eq:modcurve}
    A(\zeta) = G\left(\cos\left(2\left(\zeta+\psi\right)\right)-\frac{\epsilon+1}{\epsilon-1}\right)\left(n_1\cos(\zeta)+n_2\sin(\zeta)+1\right)
    \end{equation}
    <p>
        where $G$ is the detector gain, $\zeta$ is the RPS angle WRT gravity, $\psi$ is the detector polarization angle with respect to the source, $\epsilon$
        is the detector cross-polar response, and ($n_1,\,n_2$) are nuisance parameters to account for miscollimation of the source rotation axis.
    </p>
    <p>
        The polarization angle $\psi$ in Equation \ref{eq:modcurve} is a relative measurement and is agnostic to the orientation of the focal plane.
        We define an angle $\phi_d$, which is the polarization angle of a detector with respect to the &theta;=0 axis -- this gives us a set of parameters in cartesian coordinates $(x,\,y,\,\phi_{d})$ which is analogous to the polar set of $(r,\,\theta,\,\chi)$ [See <a href="JAC2019"></a>]. This is done by combining $\psi$ with the angle measured from the telescope's &theta;=0 axis and the RPS's &phi;=0 axis, called $\phi_s$, which is computed through the pointing model.
    </p>
    \begin{equation}
    \phi_d = \psi + \phi_s
    \end{equation}

    <p>In application, $\phi_s$ is computed for at every RPS angle to account for any polarization projection effects from the mirror<sup><a name="sup2" href="#ftn2">[2]</a></sup>:</p>


    \begin{equation}\label{eq:modcurve2}
    A(\zeta) = G\left(\cos\left(2\left(\zeta+\psi+\phi_s\right)\right)-\frac{\epsilon+1}{\epsilon-1}\right)\left(n_1\cos(\zeta)+n_2\sin(\zeta)+1\right)
    \end{equation}

    <p>This way, the angle we estimate from the modulation curve is automatically given as $\phi_d$.</p>

    <p><b>Note:</b> Our mainline CMB analysis uses detector polarization angles in terms of &chi; for inputs; I present angles in terms of $\phi_d$ here because these angles are easier to interpret since detectors line up with ~0/90&deg; as opposed to &chi; which has an additional dependence on &theta;.
        Before committing these to the pipeline, these angles will converted to their final &chi;-angle values via:
    </p>

    \begin{equation}\label{eq:chiangle}
    \chi = \phi-\theta
    \end{equation}

    <h4>Pair-Difference Polarization Angles</h4>

    <p>
        It is also useful to calculate the "pair-difference" polarization angle.
        In practice, the contribution of the cross-polar response to this angle is very small so the per-pair polarization angle can be approximated by:
    </p>
    \begin{equation}
    \phi_{pair}\sim\frac{\phi_A+\phi_B-90}{2}
    \end{equation}


    <p>We start with a Stokes vector aligned with +Q:</p>

    \begin{equation}
    S =
    \begin{bmatrix}
    I \\
    Q \\
    U \\
    \end{bmatrix}
    =
    \begin{bmatrix}
    1 \\
    1 \\
    0 \\
    \end{bmatrix}
    \end{equation}

    <p>and rotate Q into U by the per-detector polarization angle $\phi$</p>

    \begin{equation}
    S_{rot} = R(\phi)S
    \end{equation}

    <p>Where R is the rotation matrix</p>

    \begin{equation}
    R(\phi) =
    \begin{bmatrix}
    1 & 0 & 0 \\
    0 & \cos(2\phi) & -\sin(2\phi) \\
    0 & \sin(2\phi) & \cos(2\phi) \\
    \end{bmatrix}
    \end{equation}

<p>The pair-combined Stokes vector is the sum of the rotated vectors from A and B detectors as well as two additional terms to account for cross-polar response which are orthogonal to their respective A/B terms and scaled by $\epsilon$</p>

    \begin{equation}
    S_{total} = \left[R(\phi_A)+R(\phi_B+\frac{\pi}{2})+\epsilon_A R(\phi_A+\frac{\pi}{2})+ \epsilon_B R(\phi_B)\right]S
    \end{equation}

    <p>
        and the effective per-pair polarization angle $\phi_{pair}$ and polarization efficiency
     $\epsilon_{pair}$ is simply
    </p>
    \begin{equation}\label{eq:phiq}
    \begin{split}
    &\phi_{pair} = \frac{1}{2}\tan^{-1}\frac{S_3}{S_2}\\
    &\\
    &\epsilon_{pair} = \frac{\sqrt{S_2^2+S_3^2}}{S_1}
    \end{split}
    \end{equation}



    <h3>Schedule Types</h3>

    <figure class="table">
        <table class="center results">
            <tr>
                <th colspan="1">Schedule Type</th>
                <th colspan="1">Obs. Length (Hrs.)</th>
                <th colspan="1">Total Time (Hrs.)</th>
                <th colspan="1">Adjusted Parameter</th>
                <th colspan="1">Systematics Probed</th>
            </tr>
            <tr>
                <td>5</td>
                <td>13.5</td>
                <td>420.4</td>
                <td>None</td>
                <td>Standard RPS Observations</td>
            </tr>
            <tr>
                <td>6</td>
                <td>13.6</td>
                <td>13.6</td>
                <td>RPS angle -180 to 180 Minus DK angle</td>
                <td>Importance of nulling mod curve</td>
            </tr>
            <tr>
                <td>7</td>
                <td>1</td>
                <td>70.7</td>
                <td>Target Moon, only one raster</td>
                <td>Standard Moon Observations</td>
            </tr>
            <tr>
                <td>8</td>
                <td>0.1</td>
                <td>0.5</td>
                <td>No Mount Movement</td>
                <td>Rotation stage operational checks</td>
            </tr>
            <tr>
                <td>9</td>
                <td>0.5</td>
                <td>22.9</td>
                <td>Quick-turnaround 1&deg;&times;1&deg; single-pair map</td>
                <td>System stability</td>
            </tr>
            <tr>
                <td>9.1</td>
                <td>0.3</td>
                <td>3.5</td>
                <td>1&deg;&times;1&deg; map, 45&deg; increments</td>
                <td>&sigma;-Angle vs. Mod Curve Samples</td>
            </tr>
            <tr>
                <td>9.2</td>
                <td>1.1</td>
                <td>11.0</td>
                <td>1&deg;&times;1&deg; map, 10&deg; increments</td>
                <td>&sigma;-Angle vs. Mod Curve Samples</td>
            </tr>
            <tr>
                <td>9.3</td>
                <td>0.5</td>
                <td>4.6</td>
                <td>1&deg;&times;1&deg; map, No Homing between obs.</td>
                <td>RPS homing precision</td>
            </tr>
            <tr>
                <td>10</td>
                <td>3.1</td>
                <td>9.2</td>
                <td>RPS fixed & boresight rotated instead</td>
                <td>Pointing model validation</td>
            </tr>
            <tr>
                <td>11</td>
                <td>3.2</td>
                <td>9.2</td>
                <td>Rasters 27&deg; in Az</td>
                <td>Short- & long-timescale mirror deformation</td>
            </tr>

        </table>
        <figcaption>

        </figcaption>
    </figure>
    <p>Type-5 are our standard observations from which pol angles and efficiencies are derived. In previous postings, we used Type-7's and Type-11's to check for systematics in the pointing model. In this posting, we'll be using type-9's to check for systematics in our polarization angle estimates.</p>
</section>

<section><h2>Estimates of Polarization Angles and Cross-Polar Efficiency</h2>
    <p>In the pager below, I show this year's polarization angles (in terms of $\phi$, not &chi;) and cross-polar efficiency per channel and per-observation. I include the data I took in 2018 for comparison.</p>

    <figure>
        <img alt="Name pager" id="channelpager" src="#" />
        <figcaption>
            Scatter plot of polarization params as a function of GCP Channel number. <b>Top/Middle:</b> Detectors are separated by their orientation along the theta=0 axis. <b>Bottom:</b> subtracted to show orthogonality in the case of $\phi$.
            The black dashed lines indicate the MCE's.
            The colors differentiate observations.
        </figcaption>
        <script type="text/javascript">
            function fcn(params){
                return 'figs/'+params.val+'_vs_chan_090_2022.png';
            }

            pager.link("#channelpager",
                {
                    'Y-Axis|val' : ['phi','xpol'],
                    //'Year|year' : ['2018','2022'],
                },
                fcn);
            pager.setparams({
                'val' : 'phi',
                //'year': '2022',
            });
        </script>
    </figure>



    <figure>
        <img alt="Name pager" id="tileplotpager" src="#" />
        <figcaption>
            Scatter plot of polarization params as a function of GCP Channel number. <b>Top/Middle:</b> Detectors are separated by their orientation along the theta=0 axis. <b>Bottom:</b> subtracted to show orthogonality in the case of $\phi$.
            The black dashed lines indicate the MCE's.
            The colors differentiate observations.
        </figcaption>
        <script type="text/javascript">
            function fcn(params){
                return 'figs/'+params.val+'_tile_plot'+params.ms+'.png';
            }

            pager.link("#tileplotpager",
                {
                    'Y-Axis|val' : ['phi','xpol'],
                    'Med-Sub|ms' : ['Off|','On|_medsub'],
                },
                fcn);
            pager.setparams({
                'val' : 'phi',
                'ms': '',
            });
        </script>
    </figure>


</section>

<section><h2>Consistency and Statistical Uncertainty</h2>

    <p>
        I first take a look at how this dataset compares to the RPS measurements I took back in 2018 and also how it compares to the parameters that were were used for BK18. For the BK18 phis, I just do the reverse of Eq. \ref{eq:chiangle}: $\phi = \chi + \theta_{ref}$ where $\chi$ and $\theta_{ref}$ are <tt>p.chi</tt> and <tt>p.chi_thetaref</tt> from the FP data file respectively.
    </p>


    <figure>
        <img alt="Name pager" id="channelpager2" src="#" />
        <figcaption>
            Scatter plot of polarization params as a function of GCP Channel number. <b>Top/Middle:</b> Detectors are separated by their orientation along the theta=0 axis. <b>Bottom:</b> subtracted to show orthogonality in the case of $\phi$.
            The black dashed lines indicate the MCE's.
            The colors differentiate observations.
        </figcaption>
        <script type="text/javascript">
            function fcn(params){
                return 'figs/'+params.val+'_vs_chan_090_'+params.year+'.png';
            }

            pager.link("#channelpager2",
                {
                    'Y-Axis|val' : ['phi','xpol'],
                    'Year|year' : ['RPS 2018|2018','RPS 2022|2022','B18 FPU Data|exp'],
                },
                fcn);
            pager.setparams({
                'val' : 'phi',
                'year': '2022',
            });
        </script>
    </figure>

<p>We already have a qualitative confirmation that the polarization properties over the years have remained relatively unchanged (even after swapping out a window).</p>

    <p>The pager below shows direct comparisons between the 2018, and the B18 FPU 'obs' data. For 2018 vs. 2022, I compare the years per-pair where the pairs are averaged over all 4 observations for 2018 and all 10 observations for 2022. For 2022 vs. B18 FPU Data, the 2022 data is averaged over all 10 observations. For 2022 vs. 2022, I compare the averages of two subsets of 5 observations each where the 5 observations for a given subset were selected at random with no repeating observations between the two sets.</p>

    <figure>
        <img alt="Name pager" id="consistpager" src="#" />
        <figcaption>

        </figcaption>
        <script type="text/javascript">
            function fcn(params){
                return 'figs/consistplot_'+params.val+'_2022_vs_'+params.year2+'.png';
            }

            pager.link("#consistpager",
                {
                    'Comparison|val' : ['phi','xpol'],
                    'Year|year2' : ['RPS 2018|2018','RPS 2022|2022','B18 FPU Data|fpu'],
                },
                fcn);
            pager.setparams({
                'val' : 'phi',
                'year2': '2018',
            });
        </script>
    </figure>

    <p>The data between 2018 and 2022 are very consistent -- the major differences (~0.1deg shift, higher variance) can be well explained by the 2018 data having a bad tiltmeter calibration <a href="CV2021"></a>.

    </p>

    <p>For 2022 vs. B18, we see an offset of -0.778 degrees. In another posting where I create Pol Rot sims of B2018 CMB data <a href="JAC2023"></a>, we can see that this matches the angle that we'd naively expect given a mismatch between the actual angles and the angles we use to create our CMB maps<sup><a name="sup3" href="#ftn3">[3]</a></sup>.</p>

<h3>Self-consistency</h3>
    <p>I compare the 2022 data with itself by splitting the observations into two different subsets and comparing them to each other. I choose two different subsets to compare to. The first set, "Min", I find the permutation set which minimizes the mean in the difference distribution which checks for systematics between the observations -- if the mean of the difference histogram never goes to zero, then the this indicates that the observations have some systematic affecting some of the data in some way. The second set, "Max", which is the permutation that maximizes the mean in the difference histogram tells you about the scatter on the mean angle of the observations.</p>

    <figure>
        <img alt="Name pager" id="consistpager2" src="#" />
        <figcaption>

        </figcaption>
        <script type="text/javascript">
            function fcn(params){
                return 'figs/consistplot_'+params.val+'_2022_vs_'+params.subs+'.png';
            }

            pager.link("#consistpager2",
                {
                    'Comparison|val' : ['phi','xpol'],
                    'Subsets|subs' : ['min|2022_min','max|2022_max'],
                },
                fcn);
            pager.setparams({
                'val' : 'phi',
                'subs': '2022_min',
            });
        </script>
    </figure>


    <p>We can see that the mean of the distribution in "Min" is consistent with zero which indicates that statistical fluctuations are dominating the sample variance. The mean and standard deviation of the distribution in "Max" can be seen as best-estimates of the statistical uncertainty.</p>

</section>

<section>
    <h2>Systematics</h2>
<h3>Pol Angles Vs. Themselves</h3>



    <h3>Pol angles </h3>
    <figure>
        <img alt="Name pager" id="scatterpager" src="#" />
        <figcaption>

        </figcaption>
        <script type="text/javascript">
            function fcn(params){
                return 'figs/scatter_'+params.val+'_'+params.y+'_vs_'+params.x+'.png';
            }

            pager.link("#scatterpager",
                {
                    'Comparison|val' : ['phi','xpol'],
                    'Y|y': ['A|a','B|b','Diff|p'],
                    'X|x' : ['t','obsnum','az_cen','el_cen','dk_cen','az_cen_sun','el_cen_sun','x','y',
                        'xm','ym','r','theta','thetam','tilt_out','tilt_temp','tod'],
                },
                fcn);
            pager.setparams({
                'val' : 'phi',
                'y': 'a',
                'x': 't',
            });
        </script>
    </figure>




</section>

<hr>

<section class="appendix">
<h2 class="appendix">Appendix</h2>
    <h3>Channel Cuts</h3>

    <h3>Footnotes</h3>
    <p>Click on the number to return to the main text.</p>
    <div class="footnote">
        <p>
        <p>
            <a name="ftn2" href="#sup2">[2]</a>This is strictly speaking in the geometrical sense. I plan to discuss differential reflection of polarization due to the fact that the mirror is aluminum in another posting.
    </p>
        <p><a name="ftn3" href="#sup3">[3]</a>Other factors such as coverage, pair weighting and galactic dust in the maps might affect the actual difference we see in the real data.
        </p>
    </div>
    <h3>Code</h3>
    <p>Below is a list of code that was used for this analysis. The code is committed to the pipeline and can be found in the <tt>analysis/beammap/</tt> directory.</p>
    <p id="code"></p>

    <h3>Data</h3>
    <p id="data"></p>
    <h3>References</h3>

    <p id="references"></p>


    <p id="testp"></p>

    <script type="text/javascript">

        // Shorthand tags
        var codes = [
            "rps_fit_mirror_from_moon.m",
            ];

        // Posting titles
        var desc = [
            "Derives mirror parameters from observations of the moon.",
        ];

        // Make a list of references
        var post = document.getElementById("code");
        var msg = "<table class=\"code\">";
        for (var code in codes){
            msg = msg + "<tr><td><tt>"+codes[code]+"</tt></td><td> - </td><td>"+desc[code]+"</td>";
        };
        msg = msg+ "</table>";
        post.innerHTML = msg;

    </script>

    <script type="text/javascript">

        // Shorthand tags
        var data = [
            "moonsch.mat",
            ];

        // Posting titles
        var desc = [
            "Metadata of Moon observations",
            ];

        // Make a list of references
        var post = document.getElementById("data");
        var msg = "<table class=\"code\">";
        for (var datum in data) {
            msg = msg + "<tr><td><tt>" + data[datum] + "</tt></td><td> - </td><td>" + desc[datum] + "</td>";
        }
        ;
        msg = msg + "</table>";
        post.innerHTML = msg;

    </script>



    <script type="text/javascript">

        // This my way of making shorthand links.
        // We'll make a couple arrays with the 'tag' and href information
        // and then look through each anchor element for the specified tag.
        // The anchors should then just look like: <a href="tagname"></a>
        // and the script will automatically fill in the hyperlings and text.


        var posting_dir = window.location.href; // What's the current url?

        var bkurl = "bicep.rc.fas.harvard.edu";
        var spurl = "bicep.usap.gov";

        // These are the possible places to find postings
        // The strings are for if you post your posting in that directory.
        var sitemap = {
            jcornelison: "../../../",   // /jcornelison/postings/
            bkcmb : "../../../../",     // /bkcmb/analysis_logbook/analysis/
            bicep3: "../../../",        //
            bicep_array: "../../../",   //
            bicep2: "",                 // We shouldn't be posting in these, but still have postings we can reference.
            keck  : "",                 // keck/analysis_logbook/analysis/
            spuder: "",                 // ~spuder/hieno_analysis_logboo
            bicep1: "",                 // ~bicep1/analysis_logbook_north/
            general_projects:"",
                   };
        // Logbook Site map:
        // personal:www/jcornelison/postings/
        // bkcmb:   www/bkcmb/analysis_logbook/analysis/
        // keck:    www/keck/analysis_logbook/analysis/
        // BICEP3:  www/bicep3/analysis_logbook/
        // BA:      www/bicep_array/analysis_logbook/
        // We shouldn't be posting in these, but still have postings.
        // bicep2:
        // keck:    www/keck/analysis_logbook/analysis/
        // spuder:  www/~spuder/hieno_analysis_logbook/
        // bicep1:  www/~bicep1/analysis_logbook_north/


        // Shorthand tags
        var tags = [
            "KWY2007",
            "CAB2012",
            "RWO2013",
            "JBW2018a",
            "JBW2018b",
            "JAC2019",
            "JAC2021",
            "CV2021",
            "JAC2022a",
            "JAC2022b",
            "JAC2022c",
            "BS2022",
            "JAC2023",
        ];

        // Links
        // Truncate the link down to the www directory in which is lies if you can.
        var hrefs = [
            "general_projects/rps/pointing_article.pdf",
            "keck/analysis_logbook/analysis/20120510_beam_map_pointing/",
            "bkcmb/analysis_logbook/analysis/20130205_polofs_model/",
            "bkcmb/analysis_logbook/analysis/20181129_B2016_beamcen_yrquarters/",
            "bkcmb/analysis_logbook/analysis/20181207_B2018_beamcen/",
            "bkcmb/analysis_logbook/analysis/20190516_rps_pointing_defs/",
            "bkcmb/analysis_logbook/analysis/20210518_bmpm/",
            "bicep3/analysis_logbook/20210916_rps_calibration_plan/",
            "bicep3/analysis_logbook/20220428_mirror_analysis/",
            "bicep3/analysis_logbook/20220505_mirror_analysis_2/",
            "bicep3/analysis_logbook/20220816_mirror_analysis_3/",
            "bkcmb/analysis_logbook/analysis/20220922_B2021_beamcens/",
            "jcornelison/postings/20221213_birefringence_pol_rot_sims/",
        ];


        // Posting titles
        var desc = [
            "BICEP Pointing Supplement",
            "Pointing Model for Keck Beam Maps",
            "Modeling Polarization-Dependent Beam Offsets",
            "B2016 per-deck, per-scan direction beam centers for quarter-season data sets",
            "B2016, B2017, and B2018 CMB-derived beam center correlations",
            "Pointing Model Definitions for Polarized Beam Mapping",
            "A New Pointing Model for Beam Mapping",
            "RPS Summary and Austral Summer 2021/2022 Calibration Plan",
            "Deriving Mirror Properties from the Moon",
            "2022 Moon Analysis II: GCP Coordinate Systems and Moon Phases",
            "2022 Moon Analysis III: Moon Phase Correction and Mirror Systematics",
            "B2021 Beam Centers",
            "Isotropic Birefringence Analysis: Global Polarization Rotation Angles in B2018 sims",
        ];
        // Debug
        var posty = document.getElementById("testp");


        var preface = "";
        var keys = Object.keys(sitemap);
        // If we're not at pole or bicep, just post the full URL
        // If we are, go back to the www directory.
        if (posting_dir.match(new RegExp(bkurl))!=bkurl &
            posting_dir.match(new RegExp(spurl))!=spurl){
                preface = "http://" + bkurl+"/";
            }
        else {
            for (key in keys){
                if (posting_dir.match(new RegExp("/"+keys[key]+"/"))=="/"+keys[key]+"/"){
                    preface = sitemap[keys[key]];
                };
            };

        };

        // Add the prefixes we can.
        // Only add prefixes to directories in the sitemap so we don't break
        // external references.
        for (ref in hrefs) {
            for (key in keys) {

            // If there's a match, at the prefix and move on.
            if(hrefs[ref].match(new RegExp(keys[key] + "/"))==keys[key]+"/"){
                hrefs[ref] = preface+hrefs[ref];
                break;
            }
            };
        };

        // posty.innerHTML = preface;

        // Make a list of references
        var post = document.getElementById("references");
        var msg = "<table>";
        for (var tag in tags){
            msg = msg + "<tr><td><a href="+tags[tag]+"></a></td><td> - </td><td>"+desc[tag]+"</td>";
        };
        msg = msg+ "</table>";
        post.innerHTML = msg;

        // Look through all the hyperlinks and insert the proper links to the postings
        var links = document.getElementsByTagName("A");
        for (var link in links){
            for (var tag in tags){
                if (links[link].href.endsWith(tags[tag])){
                    links[link].text = "("+tags[tag]+")";
                    links[link].href = hrefs[tag];
                    links[link].target = "_blank";
                }
            }
        }

    </script>
</section>
</body>
