<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>Posting Title — J. Cornelison</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <!-- Load up MathJax for math notation -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
              tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
    </script>
    <script type="text/javascript"
            src="../mathjax/MathJax.js?config=TeX-AMS-MML_SVG">
    <!--            src="../mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML">-->
    </script>

</head>

<body>
<!-- Add my custom pager script -->
<script type="text/javascript" src="scripts/pager.js"></script>
<link rel="stylesheet" type="text/css" href="scripts/pager.css">

<header>
    <h1>RPS Analysis I: Observations and Pointing Systematics</h1>

    <time datetime="2020-xx-xx" class="published updated">
        yyyy Mmm dd
    </time> —
    J. Cornelison
</header>

<hr>

<p>
    Abstract
</p>

<hr>
<!--16 Aug 2022-->
<section>
    <h2>RPS Observations</h2>
Talk about the different RPS observations. Also include a bit about the tilt meter.
</section>

<section><h2></h2>


    <h3>Beam Centers</h3>


<p>I use the mirror parameters derived from the Moon Analysis described in <a href="JAC2022c">JAC2022c</a> and fit for a source location over all DK angles using a method similar to how we fit for mirror parameters described in &sect; 2 of <a href="JAC2022a"></a> except we take the mirror parameters in the pointing model as known and instead let the source azimuth and elevation be free parameters:</p>
    <p>With <tt>beam_map_pointing_model.m</tt> as our
        model we computer the instrument-fixed coordinates in x/y:</p>

    \begin{equation}
    [x,\,y,\,\phi] = \text{beam_map_pointing_model}(Az_{src},\,El_{src} | A_{0},\,E_{0},\,K_{0},\,Mount,\,Mirror)
    \end{equation}

    where $A_0$, $E_0$, and $D_0$ are the as-fit beam centers in raw mount coordinates<sup><a name="sup1" href="#ftn1">[1]</a></sup>; $Mount$ comprises the relevant
    mount information derived from both optical starpointing and Solidworks drawings; $Mirror$ comprises the tilt, roll and height of the mirror.

    <p>Then using CMB-derived beam centers as the 'observed' quantity, the chi-square to minimize is just:</p>

    \begin{equation}
    \chi^2=\sum \frac{(x_{CMB,i}-x_{0,i})^2+(y_{CMB,i}-y_{0,i})^2}{\sigma_i^2}
    \end{equation}

    <p>From <a href="JAC2022c">JAC2022c</a>, we have evidence that the mirror is physically moving about from measurement-to-measurement, so in the following figures -- after fitting an overall source position -- I keep the source fixed and fit for the mirror parameters per-observation (and per-rasterset as I'll discuss later).</p>
    <p>
        <font color="red">Show a pager of the quivers with Overall/per-obs mirror fits and also angle/scaling offsets applied.</font>
    </p>
    <figure>
        <figcaption>
            Quiver plots pager
        </figcaption>
    </figure>
    <p>Figure 2.2 shows a pager of the mirror tilt and roll along with an overall FPU angle and scaling fits as a function of multiple different variables to probe of possible sources of systemtatics. The data are color-coded by the chronological order in which the observations were taken.</p>


    <ul>
        <li>
            <b>Y-Axis</b> - Dependent variable. FPU Angle/Scale overall uses a fixed parameter for the mirror location whereas FPU Angle/Scale per obs uses the per-obs (or per-rastersets) fits for the mirror when calculating x/y coordinates to derive the angle/scaling.
        </li>
        <li>
            <b>X-Axis</b> - Independent variable. $x_m$, $y_m$ and $\theta_m$ are the beam centeroids with the DK-angle derotated to get us into a quasi-mirror-fixed coordinate system. The tiltmeter values are the tilt readout at the start of the obs or rasterset and so only make sense for the per-rasterset click.
        </li>
        <li>
            <b>Target</b> - Switch between Moon and RPS Main (Type 5) data.
        </li>
        <li>
            <b>Resolution</b> - A data point represents either an entire observation or a single rasterset (or just raster for the Moon data) within that observation. I included this option because while the Moon observations only take 3 hours, the RPS observations take ~39 hours to complete and thus any diurnal effects would be washed out. RPS rastersets take ~40 minutes to complete which are much close in time resolution to the Moon data.
        </li>
        <li>
            <b>Moon Data Cut</b> - Use mirror parameters from <a href="JAC2022c">JAC2022c</a> Table 2.2 for computing the source location in the RPS analysis: without the <i>Early</i> data (Nov30-Dec6) or <i>Late</i> data (Dec9-Jan26) -- the late data cut uses Tilt=44.88 Roll=-0.09.
        </li>

    </ul>

    <figure>
        <img alt="Maps pager" id="versuspager" src="#" width="100%"/>
        <figcaption>

        </figcaption>
        <script type="text/javascript">
            pager.link("#versuspager",
                {
                    'Y-Axis|param' : ['Tilt|tilt','Roll|roll','FPU Angle Overall|fpu_ang','FPU Scale Overall|fpu_scale','FPU Angle per obs|fpu_ang_obs','FPU Scale per obs|fpu_scale_obs'],
                    'X-Axis|x' : ['Time|t','Time-of-day|tod','DK|dk','Sun-Src El|sun_els','Sun-Src Az|sun_azs','Mirror Tilt|tilt','Mirror Roll|roll','$x$|x','$y$|y','$r$|r','$\\theta$|theta','$x_m$|xm','$y_m$|ym','$\\theta_m$|thm','tiltmeter'],
                    'Target|tgt': ['Moon|moon','RPS|rps'],
                    'Resolution|res': ['per-obs|perobs','per-rasterset|perscan'],
                    'Moon Data Cut|cut': ['Off|_nocut', 'Early|_earlycut','Late|_latecut'],
                },

                function(params) {
                    return 'figs/'+params.param+'_vs_'+params.x+'_'+params.tgt+'_'+params.res+params.cut+'.png';
                });
            pager.setparams({
                'param': 'tilt',
                'x': 't',
                'tgt': 'moon',
                'res': 'perobs',
                'cut': '_nocut',
            });
        </script>
    </figure>

    <p>Important clicks:</p>
    <ol>
        <li>
            <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_scale_obs','x': 'sun_azs','tgt': 'moon','res':'perobs'})">Moon</a> and <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_scale_obs','x': 'sun_azs','tgt': 'rps','res':'perscan'})">RPS</a> Scaling vs. Sun-Target Azimuth: We saw some indication in the Moon data that the scaling of the mirror was affected by the location of the Sun with respect to the mirror pointing. We don't see this effect in the RPS data so if this effect is real, the time constant must be longer than diurnal timescales.

        </li>
        <li>
            <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_ang','x': 'roll','tgt': 'rps'})">Angle Overall vs. Roll</a> and <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_ang_obs','x': 'roll','tgt': 'rps'})">Angle Per-Obs vs. Roll</a>:
            See a similar behavior to the Moon data -- Using an overall fit induces an apparent rotation on the focal plane indicating the changes in Roll are real.
        </li>
        <li>
            <a href="javascript:void(0)" onclick="pager.setparams({'param': 'roll','x': 'thm','tgt': 'moon','res':'perscan'})">Moon Roll vs. $\theta_m$</a> and <a href="javascript:void(0)" onclick="pager.setparams({'param': 'roll','x': 'thm','tgt': 'rps','res':'perscan'})">RPS Roll vs. $\theta_m$</a>: We see structure in the Mirror Roll as a function of a mirror-fixed theta which appears relatively consistent between the Moon and RPS data (this is most easily seen when <a href="javascript:void(0)" onclick="pager.setparams({'cut':'_earlycut'})">Early</a> or <a href="javascript:void(0)" onclick="pager.setparams({'cut':'_latecut'})">Late</a> cut is turned on).
        </li>
        <li>
            <a href="javascript:void(0)" onclick="pager.setparams({'param': 'tilt','x': 'thm','tgt': 'moon','res':'perscan'})">Moon Tilt vs. $\theta_m$</a> and <a href="javascript:void(0)" onclick="pager.setparams({'param': 'tilt','x': 'thm','tgt': 'rps','res':'perscan'})">RPS Tilt vs. $\theta_m$</a>: We see structure in the Mirror Tilt in mirror-fixed theta, but the features aren't as consistent between the Moon and RPS data as the Roll was.
        </li>
        <li>
            <a href="javascript:void(0)" onclick="pager.setparams({'param': 'roll','x': 'tiltmeter','tgt': 'rps','res':'perscan'})">RPS Roll vs. Tiltmeter</a>: There's no obvious dependence in Mirror Roll on the tiltmeter which provides more evidence that the RPS isn't moving in Azimuth to any significant degree.
        </li>
        <li>
            RPS Angle Vs. Time with <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_ang_obs','x': 't','tgt': 'rps','res':'perobs','cut':'_latecut'})">Late</a>, <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_ang_obs','x': 't','tgt': 'rps','res':'perobs','cut':'_nocut'})">Off</a>, and <a href="javascript:void(0)" onclick="pager.setparams({'param': 'fpu_ang_obs','x': 't','tgt': 'rps','res':'perobs','cut':'_earlycut'})">Early</a> cuts:
        </li>
    </ol>




<!--    <p></p>-->
<!--    <figure>-->
<!--        <img alt="Name pager" id="quiver2pager" src="#" />-->
<!--        <figcaption>-->

<!--        </figcaption>-->
<!--        <script type="text/javascript">-->
<!--            function fcn(params){-->
<!--                    return 'figs/quiver_'+params.fit+'_dk_'+params.dk+params.coord+'.png';-->
<!--            }-->

<!--            pager.link("#quiver2pager",-->
<!--                {-->
<!--                    'Fit|fit' : ['None|none','Angle|angfit','scalefit','transfit','all'],-->
<!--                    'DK|dk' : ['-81','0','23','45','61','68_1','68_2','90','135','174'],//, '0_1', '0_2','90_2','90_3','-68','-23'],-->
<!--                    'Coord|coord' : ['Inst Fixed|'],//,'Mirror Fixed|_mirror'],-->
<!--                 },-->
<!--            fcn);-->
<!--            pager.setparams({-->
<!--                'fit': 'none',-->
<!--                'dk' : '61',-->
<!--                'coord': '',-->
<!--            });-->
<!--        </script>-->
<!--        </figure>-->

<!--    <figure>-->
<!--        <img src="figs/fpu_rot_vs_dk.png" />-->
<!--        <figcaption>-->

<!--        </figcaption>-->
<!--    </figure>-->

</section>


<hr>

<section class="appendix">
<h2 class="appendix">Appendix</h2>
    <h3>Footnotes</h3>
    <div class="footnote">
        <p>These are footnotes. Click the number to return to main text.</p>
        <p>
        <sup><a name="ftn1" href="#sup1">[1]</a></sup> Note that the beam centroids for RPS data are calculated over the beams of all 13 rasters in a rasterset to both mitigate pointing effects from the Roger Effect (cite) and to allow good beam centroid fits for rasters during which the RPS angle is orthogonal to a given detector and the SNR on the beam amplitude is low.
    </p>
    </div>
    <h3>Code</h3>
    <p>Below is a list of code that was used for this analysis. The code is committed to the pipeline and can be found in the <tt>analysis/beammap/</tt> directory.</p>
    <p id="code"></p>

    <h3>Data</h3>
    <p id="data"></p>
    <h3>References</h3>

    <p id="references"></p>


    <p id="testp"></p>

    <script type="text/javascript">

        // Shorthand tags
        var codes = [
            "rps_fit_mirror_from_moon.m",
            ];

        // Posting titles
        var desc = [
            "Derives mirror parameters from observations of the moon.",

        ];

        // Make a list of references
        var post = document.getElementById("code");
        var msg = "<table class=\"code\">";
        for (var code in codes){
            msg = msg + "<tr><td><tt>"+codes[code]+"</tt></td><td> - </td><td>"+desc[code]+"</td>";
        };
        msg = msg+ "</table>";
        post.innerHTML = msg;

    </script>

    <script type="text/javascript">

        // Shorthand tags
        var data = [
            "moonsch.mat",
            ];

        // Posting titles
        var desc = [
            "Metadata of Moon observations",
            ];

        // Make a list of references
        var post = document.getElementById("data");
        var msg = "<table class=\"code\">";
        for (var datum in data) {
            msg = msg + "<tr><td><tt>" + data[datum] + "</tt></td><td> - </td><td>" + desc[datum] + "</td>";
        }
        ;
        msg = msg + "</table>";
        post.innerHTML = msg;

    </script>



    <script type="text/javascript">

        // This my way of making shorthand links.
        // We'll make a couple arrays with the 'tag' and href information
        // and then look through each anchor element for the specified tag.
        // The anchors should then just look like: <a href="tagname"></a>
        // and the script will automatically fill in the hyperlings and text.


        var posting_dir = window.location.href; // What's the current url?

        var bkurl = "bicep.rc.fas.harvard.edu";
        var spurl = "bicep.usap.gov";

        // These are the possible places to find postings
        // The strings are for if you post your posting in that directory.
        var sitemap = {
            jcornelison: "../../../",   // /jcornelison/postings/
            bkcmb : "../../../../",     // /bkcmb/analysis_logbook/analysis/
            bicep3: "../../../",        //
            bicep_array: "../../../",   //
            bicep2: "",                 // We shouldn't be posting in these, but still have postings.
            keck  : "",                 // keck/analysis_logbook/analysis/
            spuder: "",                 // ~spuder/hieno_analysis_logboo
            bicep1: "",                 // ~bicep1/analysis_logbook_north/
                   };
        // Logbook Site map:
        // personal:www/jcornelison/postings/
        // bkcmb:   www/bkcmb/analysis_logbook/analysis/
        // keck:    www/keck/analysis_logbook/analysis/
        // BICEP3:  www/bicep3/analysis_logbook/
        // BA:      www/bicep_array/analysis_logbook/
        // We shouldn't be posting in these, but still have postings.
        // bicep2:
        // keck:    www/keck/analysis_logbook/analysis/
        // spuder:  www/~spuder/hieno_analysis_logbook/
        // bicep1:  www/~bicep1/analysis_logbook_north/

        // Shorthand tags
        var tags = [
            "CAB2012",
            "JAC2022a",
            "JAC2022b",
            "JAC2022c",
        ];

        // Links
        // Truncate the link down to the www directory in which is lies if you can.
        var hrefs = [
            "keck/analysis_logbook/analysis/20120510_beam_map_pointing/",
            "bicep3/analysis_logbook/20220428_mirror_analysis/",
            "bicep3/analysis_logbook/20220505_mirror_analysis_2/",
            "jcornelison/postings/20220617_mirror_analysis_3/",
        ];


        // Posting titles
        var desc = [
            "Pointing Model for Keck Beam Maps",
            "Deriving Mirror Properties from the Moon",
            "2022 Moon Analysis II: GCP Coordinate Systems and Moon Phases",
            "2022 Moon Analysis III: Pointing Systematics",

        ];
        // Debug
        var posty = document.getElementById("testp");


        var preface = "";
        var keys = Object.keys(sitemap);
        // If we're not at pole or bicep, just post the full URL
        // If we are, go back to the www directory.
        if (posting_dir.match(new RegExp(bkurl))!=bkurl &
            posting_dir.match(new RegExp(spurl))!=spurl){
                preface = "http://" + bkurl+"/";
            }
        else {
            for (key in keys){
                if (posting_dir.match(new RegExp("/"+keys[key]+"/"))=="/"+keys[key]+"/"){
                    preface = sitemap[keys[key]];
                };
            };

        };

        // Add the prefixes we can.
        // Only add prefixes to directories in the sitemap so we don't break
        // external references.
        for (ref in hrefs) {
            for (key in keys) {

            // If there's a match, at the prefix and move on.
            if(hrefs[ref].match(new RegExp(keys[key] + "/"))==keys[key]+"/"){
                hrefs[ref] = preface+hrefs[ref];
                break;
            }
            };
        };

        // posty.innerHTML = preface;

        // Make a list of references
        var post = document.getElementById("references");
        var msg = "<table>";
        for (var tag in tags){
            msg = msg + "<tr><td><a href="+tags[tag]+"></a></td><td> - </td><td>"+desc[tag]+"</td>";
        };
        msg = msg+ "</table>";
        post.innerHTML = msg;

        // Look through all the hyperlinks and insert the proper links to the postings
        var links = document.getElementsByTagName("A");
        for (var link in links){
            for (var tag in tags){
                if (links[link].href.endsWith(tags[tag])){
                    links[link].text = "("+tags[tag]+")";
                    links[link].href = hrefs[tag];
                    links[link].target = "_blank";
                }
            }
        }

    </script>
</section>

<!--    <p>-->
<!--    I fit the detector beams over all the beam maps in a rasterset with one amplitude parameter per raster (usually 13) and with just  one parameter each for beam center, beam width, and correlation coefficient fit over all the beams in the rasterset. With RPS-derived beam centers, I fit for a source position using the mirror parameters given in <a href="JAC2022c"></a> per-DK.-->
<!--    </p>-->

<!--    <figure>-->

<!--        <img alt="Name pager" id="sourcepager" src="#" />-->
<!--        <figcaption>-->

<!--        </figcaption>-->
<!--        <script type="text/javascript">-->
<!--            pager.link("#sourcepager",-->
<!--                {-->
<!--                    'Param|parm': ['Az|az','El|el'],-->

<!--                },-->
<!--                function(params) {-->
<!--                    return 'figs/source_fit_'+params.parm+'.png';-->
<!--                });-->
<!--            pager.setparams({-->
<!--                'parm':'az',-->
<!--            });-->
<!--        </script>-->
<!--    </figure>-->

<!--    <p>As we expected from <a href="JAC2022c"></a>, we see fluctuations in the apparent source position over time. We expect this is actually due to the mirror deforming and not the source as we'd expect to see corresponding shifts in the tilt meter of $O(0.5^\circ)$, which we don't. Instead, what I've chosen to do is assume that the actual source position is the mean across all observations and then refit for the mirror orientation on per-DK and per-schedule bases. This step is important because it ensures we're properly accounting for the addition rotation of the focal plane induced by the mirror roll parameter.</p>-->

<!--    <p></p>-->

<!--    <figure>-->
<!--        <img alt="Name pager" id="mirrorpager" src="#" />-->
<!--        <figcaption>-->

<!--        </figcaption>-->
<!--        <script type="text/javascript">-->
<!--            pager.link("#mirrorpager",-->
<!--                {-->
<!--                    'Param|parm2': ['Tilt|tilt','Roll|roll'],-->

<!--                },-->
<!--                function(params) {-->
<!--                    return 'figs/mirror_fit_'+params.parm2+'.png';-->
<!--                });-->
<!--            pager.setparams({-->
<!--                'parm2':'roll',-->
<!--            });-->
<!--        </script>-->
<!--    </figure>-->

<!--    <p>The pager below shows quivers of beam-center residuals. </p>-->

<!--    <figure>-->
<!--        <img alt="Name pager" id="quiverpager" src="#" />-->
<!--        <figcaption>-->

<!--        </figcaption>-->
<!--        <script type="text/javascript">-->
<!--            pager.link("#quiverpager",-->
<!--                {-->
<!--                    '|parm3': ['Source|source','Mirror|mirror'],-->
<!--                    'Fit|fit' : ['perdk','persch'],-->
<!--                    'DK|dk' : ['61', '23','174','68_1','-81','90','45','135','68_2'],-->

<!--                },-->
<!--                function(params) {-->
<!--                    return 'figs/quiver_'+params.parm3+'_'+params.fit+'_dk_'+params.dk+'.png';-->
<!--                });-->
<!--            pager.setparams({-->
<!--                'parm3':'source',-->
<!--                'fit': 'perdk',-->
<!--                'dk' : '61'-->
<!--            });-->
<!--        </script>-->
<!--    </figure>-->


</body>
