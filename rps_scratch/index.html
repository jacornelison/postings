<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>Scratch — J. Cornelison</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <!-- Load up MathJax for math notation -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
              tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
    </script>
    <script type="text/javascript"
            src="../mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

</head>

<body>
<!-- Add my custom pager script -->
<script type="text/javascript" src="scripts/pager.js"></script>
<link rel="stylesheet" type="text/css" href="scripts/pager.css">

<header>
    <h1></h1>

    <time datetime="2020-xx-xx" class="published updated">
        2021 Mmm dd
    </time> —
    J. Cornelison
</header>

<hr>

<p>
    
</p>

<hr>

<p>In most beams analysis (FFBM, RPS, FSL), the procedure to create beam maps from raw data is essentially the same:
    <ol>
    <li>
        Convert Raw Mount Coordinates $(A_0,E_0,K_0)$ into topocentric ideal horizontal coordinates $(A,E,K)$
        <ul>
            <li>Uses <tt>invpointing_model.m</tt> with star pointing model as an additional input.</li>
        </ul>
    </li>
    <li>
        Convert ideal topocentric coordinates $(A,E,K)$ to detector-centered $(x',y',\phi')$ coordinates.
        <ul>
            <li>
                Uses <tt>keck_beam_map_pointing.m</tt> with mount, mirror, source, and FPU information as additional inputs.
            </li>
        </ul>
    </li>
</ol>

<p>
    The inverse pointing model returns the horizontal coordinates of the mount boresight pointing as they are projected on to the local topocentric unit sphere.
    As as result, if we have non-zero Az/El tilts, we can expect to wide swings in Azimuth and Deck as the boresight approaches Zenith.
     However, only these ideal coordinates are passed to the beam map pointing model and so we lose the knowledge of the physical orientation of the source.
    As can be seen in Figure ##, this can introduce large errors in the scan as projected into instrument-fixed coordinates as the pointing model blindly assumes that the orientation of the focal plane rapidly changes as well.
</p>
<figure>
    <img src="figs/rps_scratch_mount_horiz_compare.png" width="100%"/>
    <figcaption>

    </figcaption>
</figure>

<p>


    <p>Simply put, we've been using these functions incorrectly, but neither pointing model adequately provides the functionality we need. To fix that, we created a new function which moves the function of <tt>invpointing_model</tt> into <tt>keck_beam_map_pointing</tt> and named it <tt>beam_map_pointing_model.m</tt>. We created this new function in lieu of just upgrading <tt>keck_beam_map_pointing</tt> to avoid breaking other analysis pipelines and also because the <it>Keck</it> prefix is a bit confusing since the experiment technically doesn't exist anymore. Th new function: 
    <ul>
        <li>Converts Raw Mount Coordinates $(A_0,E_0,K_0)$ directly to detector-centered coordinates $(x',y',\phi')$ or any intermediate coordinate system.</li>
        <li>Takes offline pointing model, mount, mirror, source, and focal plane information as additional inputs.</li>
    </ul>
    </p>
    <p>One thing Colin points out in his posting is that <tt>keck_beam_map_pointing</tt> doesn't apply mount tilts to the pointing of the mirror which we need to account for in RPS analyses. Some of the <tt>keck_beam_map_pointing</tt> subfunctions have been updated, but have been done so in such a way that conserves backward compatibility.
    <ul>
        <li><tt>kbmp_mirror</tt> now applies az/el tilts to the mirror normal.</li>
        <li><tt>kbmp_mount</tt> can now account for the origin of az/el tilts.</li>
    </ul>
    </p>

</p>

<section><h2>Code Tests</h2>

    <p>Below I compare the outputs of <tt>beam_map_pointing_model</tt> to <tt>invpointing_model.m</tt> and <tt>keck_beam_map_pointing.m</tt> to show that the internal mechanics are functionally unchanged. Comparison is accomplished simply by passing no mirror or source parameters to <tt>beam_map_pointing_model</tt>. For most cases, the residuals are close to (but not quite) machine precision.</p>

    <figure>
        <img alt="pager" id="pmpager" src="#" width="100%"/>
        <figcaption>
            The caption.
        </figcaption>
        <script type="text/javascript">
            pager.link("#pmpager",
                {
                    'Az Tilt Lat|lat':['-1','0','1'],
                    'Az Tilt HA|ha': ['-1','0','1'],
                    'El Tilt HA|el': ['-1','0','1'],
                },
                function(params) {
                    return 'figs/pm_compare_lat_'+params.lat+'_ha_'+params.ha+'_el_'+params.el+'.png';
                });
            pager.setparams({
                'lat': '0',
                'ha': '0',
                'el': '0',
            });
        </script>
    </figure>

<p>Note that the residuals are relatively high for any non-zero combination of Az tilt Lat/HA. It's not clear to me why that is. Regardless, the actual Az tilt lat/HA's from star pointing are much smaller (<0.5 arcmin) and the residuals are O($10^{-9}$ &deg;) at most so we should be okay to proceed.</p>

</section>


<section><h2>Physical tilt origins</h2>

    <p>Because we use nearby terrestrial sources, we account for parallactic effects and thus may need to consider the <i>origin</i> of the tilts as well since they affect the position of the aperture and mirror. The tilted base case could also include the tilt of the entire building.</p>


    <figure>
        <img src="figs/tilt_diagram.png" width="60%"/>
    </figure>



    <figure>
        <img alt="pager" id="tiltspager" src="#" width="60%"/>
        <figcaption>
            The caption.
        </figcaption>
        <script type="text/javascript">
            pager.link("#tiltspager",
                {
                    'Axis|a':['az','el'],
                    'Case|c': ['1','2'],
                },
                function(params) {
                    return 'figs/'+params.a+'tilt_case_'+params.c+'.png';
                });
            pager.setparams({
                'a': 'az',
                'c': '1',
            });
        </script>
    </figure>

    <p>How much does this actually matter though? The worst-case scenarios are listed below. The upper limit on the individual possible bias is roughly on the level of the systematic error I calculated for the mirror roll from error propagation. BUT the direction of the tilts may serve to cancel-out some effects. So while not immediately worrying, this may need further investigation in the future. For now, we place the origin of the Azimuth tilt at the base of the telescope and the origin of the Elevation tilt at elevation axis.</p>
        <table class="results center">
        <tr>
            <th>Tilt Dir.</th>
            <th>Case</th>
            <th>Tilt (from Starpointing) (&deg;)</th>
            <th>Roll Bias (&deg;)</th>
            <th>Angle Bias (&deg;)</th>
        </tr>
        <tr>
            <td>Az HA</td>
            <td>Tilted Building (<20m)</td>
            <td>~0.003</td>
            <td>~0.02</td>
            <td>~0.02</td>
        </tr>
        <tr>
            <td>El HA</td>
            <td>Upper Az bearing (<4m)</td>
            <td>~-0.03</td>
            <td>~-0.03</td>
            <td>~-0.03</td>
        </tr>
    </table>

</section>
<!--<section>-->
<!--    <p>The RPS residuals look pretty strange compared to the mirror best-fit residuals.</p>-->

<!--    <figure>-->
<!--        <table>-->
<!--            <tr>-->

<!--                <td><img src="figs/moonfit_residuals_quiver_zoomed_dk0_beamfit.png" width="500px"/></td>-->
<!--                <td><img src="figs/rps_scratch_rps_quiver_ipm_tilts.png" width="500px"/></td>-->

<!--            </tr>-->
<!--        </table>-->
<!--        <figcaption>-->
<!--            Mirror parameter best-fit beam-center residuals from Jan 2017 Moon observations (Left) and Source parameter best-fit beam-center residuals from Jan 2017 RPS observations. Note that there is no scaling on the source parameter residuals.-->
<!--        </figcaption>-->
<!--    </figure>-->

<!--    <p>-->
<!--        Looking at the RPS scans, we can see that both Azimuth and Deck appear to diverge at the elevation approaches 90&deg;. This is the expected behavior because the inverse pointing model projects the mount orientation into ideal topocentric coordinated. But because the pointing model doesn't know the actual orientation of the mount and converts these values literally, resulting in the scan apparently bunching up in boresight-centered coordinates.-->
<!--    </p>-->

<!--    <p>... But since <tt>keck_beam_map_pointing</tt> </p>-->

<!--    <p>-->
<!--        The <tt>keck_beam_map_pointing</tt> code has functionality to apply Az/El tilts. Without a  mirror, it still has the same problem when the telescope is pointed at zenith. But this problem goes away when using a mirror since the apparent az/el/pa are calculated after the mirror rotation when the apparent pointing is far away from Zenith.-->
<!--    </p>-->

<!--    <figure>-->
<!--        <table>-->
<!--            <tr>-->

<!--                <td><img src="figs/rps_scratch_app_azel_ipm_tilts.png" width="500px"/></td>-->
<!--                <td><img src="figs/rps_scratch_app_pael_ipm_tilts.png" width="500px"/></td>-->

<!--            </tr>-->
<!--            <tr>-->
<!--                <td><img src="figs/rps_scratch_app_azel_kbmp_tilts.png" width="500px"/></td>-->
<!--                <td><img src="figs/rps_scratch_app_pael_kbmp_tilts.png" width="500px"/></td>-->
<!--            </tr>-->

<!--        </table>-->
<!--        <figcaption>-->
<!--            Apparent az/el/parallactic angle are calculated via <tt>keck_beam_map_pointing</tt> using a grid of topocentric coords as inputs spanning 10 degrees in Azimuth and 20 degrees in Elevations at a DK=0; Az/El tilts given by 03 Feb 2017 starpointing; an ideal mirror (tilt=45&deg;, roll=0&deg;); and using (<b>Top Row</b>) tilts applied through <tt>invpointing_model</tt> and (<b>Bottom Row</b>) tilts applied through <tt>keck_beam_map_pointing</tt>.-->
<!--        </figcaption>-->
<!--    </figure>-->

<!--    <p>So I've elected instead to apply the tilts through <tt>keck_beam_map_pointing</tt> for moon analysis. The best-fit roll parameter changes by O(0.1&deg;)!</p>-->


<!--    <figure>-->
<!--        <table>-->
<!--            <tr>-->

<!--                <td><img src="figs/moonfit_residuals_quiver_zoomed_dkall_beamfit.png" width="500px"/></td>-->
<!--                <td><img src="figs/rps_scratch_moon_quiver_kbmp_tilts.png" width="500px"/></td>-->

<!--            </tr>-->
<!--        </table>-->

<!--    </figure>-->

<!--    <p>Applying the change to source derivation analysis, we see the beam-center residuals drastically reduced and appear to be more akin to the residuals we see in the mirror.</p>-->


<!--    <figure>-->
<!--        <table>-->
<!--            <tr>-->

<!--                <td><img src="figs/rps_scratch_rps_quiver_ipm_tilts.png" width="500px"/></td>-->
<!--                <td><img src="figs/rps_scratch_rps_quiver_kbmp_tilts.png" width="500px"/></td>-->

<!--            </tr>-->
<!--        </table>-->

<!--    </figure>-->



<!--    &lt;!&ndash;-->
<!--    <figure>-->
<!--        <img alt="pager" id="polspager" src="#" />-->
<!--        <figcaption>-->
<!--            The caption.-->
<!--        </figcaption>-->
<!--        <script type="text/javascript">-->
<!--            pager.link("#polspager",-->
<!--                {-->
<!--                    'Param|p': ['1|_one','2|_two'],-->
<!--                },-->
<!--                function(params) {-->
<!--                    return 'figs/fig'+params.p+'.png';-->
<!--                });-->
<!--            pager.setparams({-->
<!--                'p': '2',-->
<!--            });-->
<!--        </script>-->
<!--    </figure>-->
<!--&ndash;&gt;-->

<!--</section>-->


<hr>

<section class="appendix">
<h2 class="appendix">Appendix</h2>
    <h3>Code</h3>
    <p>Below is a list of code that was used for this analysis. The code is committed to the pipeline and can be found in the <tt>analysis/beammap/</tt> directory.</p>
    <p id="code"></p>


    <h3>References</h3>

    <p id="references"></p>

    <p id="testp"></p>

<!--    <script type="text/javascript">-->

<!--        // Shorthand tags-->
<!--        var codes = [-->
<!--            "",-->
<!--            ];-->

<!--        // Posting titles-->
<!--        var desc = [-->
<!--            "",-->
<!--        ];-->

<!--        // Make a list of references-->
<!--        var post = document.getElementById("code");-->
<!--        var msg = "<table class=\"code\">";-->
<!--        for (var code in codes){-->
<!--            msg = msg + "<tr><td><tt>"+codes[code]+"</tt></td><td> - </td><td>"+desc[code]+"</td>";-->
<!--        };-->
<!--        msg = msg+ "</table>";-->
<!--        post.innerHTML = msg;-->

<!--    </script>-->


<!--    <script type="text/javascript">-->

<!--        // This my way of making shorthand links.-->
<!--        // We'll make a couple arrays with the 'tag' and href information-->
<!--        // and then look through each anchor element for the specified tag.-->
<!--        // The anchors should then just look like: <a href="tagname"></a>-->
<!--        // and the script will automatically fill in the hyperlings and text.-->


<!--        var posting_dir = window.location.href; // What's the current url?-->

<!--        var bkurl = "bicep.rc.fas.harvard.edu";-->
<!--        var spurl = "bicep.usap.gov";-->

<!--        // These are the possible places to find postings-->
<!--        // The strings are for if you post your posting in that directory.-->
<!--        var sitemap = {-->
<!--            jcornelison: "../../../",   // /jcornelison/postings/-->
<!--            bkcmb : "../../../../",     // /bkcmb/analysis_logbook/analysis/-->
<!--            bicep3: "../../../",        //-->
<!--            bicep_array: "../../../",   //-->
<!--            bicep2: "",                 // We shouldn't be posting in these, but still have postings.-->
<!--            keck  : "",                 // keck/analysis_logbook/analysis/-->
<!--            spuder: "",                 // ~spuder/hieno_analysis_logboo-->
<!--            bicep1: "",                 // ~bicep1/analysis_logbook_north/-->
<!--                   };-->
<!--        // Logbook Site map:-->
<!--        // personal:www/jcornelison/postings/-->
<!--        // bkcmb:   www/bkcmb/analysis_logbook/analysis/-->
<!--        // keck:    www/keck/analysis_logbook/analysis/-->
<!--        // BICEP3:  www/bicep3/analysis_logbook/-->
<!--        // BA:      www/bicep_array/analysis_logbook/-->
<!--        // We shouldn't be posting in these, but still have postings.-->
<!--        // bicep2:-->
<!--        // keck:    www/keck/analysis_logbook/analysis/-->
<!--        // spuder:  www/~spuder/hieno_analysis_logbook/-->
<!--        // bicep1:  www/~bicep1/analysis_logbook_north/-->

<!--        // Shorthand tags-->
<!--        var tags = [-->
<!--            "",-->
<!--        ];-->

<!--        // Links-->
<!--        // Truncate the link down to the www directory in which is lies if you can.-->
<!--        var hrefs = [-->
<!--            "",-->
<!--        ];-->


<!--        // Posting titles-->
<!--        var desc = [-->
<!--            "",-->
<!--        ];-->
<!--        // Debug-->
<!--        var posty = document.getElementById("testp");-->


<!--        var preface = "";-->
<!--        var keys = Object.keys(sitemap);-->
<!--        // If we're not at pole or bicep, just post the full URL-->
<!--        // If we are, go back to the www directory.-->
<!--        if (posting_dir.match(new RegExp(bkurl))!=bkurl &-->
<!--            posting_dir.match(new RegExp(spurl))!=spurl){-->
<!--                preface = "http://" + bkurl+"/";-->
<!--            }-->
<!--        else {-->
<!--            for (key in keys){-->
<!--                if (posting_dir.match(new RegExp("/"+keys[key]+"/"))=="/"+keys[key]+"/"){-->
<!--                    preface = sitemap[keys[key]];-->
<!--                };-->
<!--            };-->

<!--        };-->

<!--        // Add the prefixes we can.-->
<!--        // Only add prefixes to directories in the sitemap so we don't break-->
<!--        // external references.-->
<!--        for (ref in hrefs) {-->
<!--            for (key in keys) {-->

<!--            // If there's a match, at the prefix and move on.-->
<!--            if(hrefs[ref].match(new RegExp(keys[key] + "/"))==keys[key]+"/"){-->
<!--                hrefs[ref] = preface+hrefs[ref];-->
<!--                break;-->
<!--            }-->
<!--            };-->
<!--        };-->

<!--        // posty.innerHTML = preface;-->

<!--        // Make a list of references-->
<!--        var post = document.getElementById("references");-->
<!--        var msg = "<table>";-->
<!--        for (var tag in tags){-->
<!--            msg = msg + "<tr><td><a href="+tags[tag]+"></a></td><td> - </td><td>"+desc[tag]+"</td>";-->
<!--        };-->
<!--        msg = msg+ "</table>";-->
<!--        post.innerHTML = msg;-->

<!--        // Look through all the hyperlinks and insert the proper links to the postings-->
<!--        var links = document.getElementsByTagName("A");-->
<!--        for (var link in links){-->
<!--            for (var tag in tags){-->
<!--                if (links[link].href.endsWith(tags[tag])){-->
<!--                    links[link].text = "("+tags[tag]+")";-->
<!--                    links[link].href = hrefs[tag];-->
<!--                    links[link].target = "_blank";-->
<!--                }-->
<!--            }-->
<!--        }-->

<!--    </script>-->
</section>
</body>
